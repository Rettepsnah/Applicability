<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veileder (EU) 2025/20 - Ground Handling</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        /* --- GRUNNLEGGENDE STIL (SORA / CAA STIL) --- */
        :root {
            --caa-blue: #003057;       
            --caa-blue-light: #0056b3; 
            --caa-bg: #f4f6f8;         
            --card-bg: #ffffff;
            
            --text-main: #333333;
            --text-muted: #666666;
            
            --border-color: #dce1e6;
            --radius-main: 6px;
            
            --status-success: #d4edda;
            --status-success-text: #155724;
            --status-warning: #fff3cd;
            --status-warning-text: #856404;
            --status-danger: #f8d7da;
            --status-danger-text: #721c24;

            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: var(--caa-bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- HEADER MED LOGO --- */
        header {
            background-color: var(--caa-blue);
            color: white;
            padding: 0 20px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            height: 40px;
            width: auto;
        }

        header h1 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            padding-left: 20px;
            border-left: 1px solid rgba(255,255,255,0.3);
            line-height: 1.2;
        }

        /* --- TABS NAVIGATION --- */
        .tabs-container {
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .tabs {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            padding: 0 15px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 20px 25px;
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .tab-btn:hover {
            color: var(--caa-blue);
        }

        .tab-btn.active {
            color: var(--caa-blue);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--caa-blue);
        }

        /* --- MAIN CONTAINER --- */
        .main-container {
            width: 100%;
            max-width: 900px;
            margin: 30px auto;
            padding: 0 15px;
            flex-grow: 1;
        }

        /* --- TAB CONTENT AREAS --- */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- CARD STYLE --- */
        .app-card {
            background: var(--card-bg);
            border-radius: var(--radius-main);
            box-shadow: var(--shadow-card);
            padding: 40px;
            border: 1px solid var(--border-color);
            min-height: 400px;
            position: relative;
        }

        /* --- FLOWCHART IMAGE STYLE --- */
        .flowchart-wrapper {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: var(--radius-main);
            box-shadow: var(--shadow-card);
        }
        
        .flowchart-img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* --- RESTEN AV STILEN FRA FORRIGE VERSJON (VEILEDER) --- */
        h2.question-title { margin-top: 0; font-size: 1.5rem; color: var(--caa-blue); margin-bottom: 10px; }
        .subtext { color: var(--text-muted); margin-bottom: 25px; font-size: 1rem; line-height: 1.5; }

        .btn { display: inline-block; padding: 12px 24px; font-size: 1rem; font-weight: 600; text-align: center; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s, transform 0.1s; text-decoration: none; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background-color: var(--caa-blue-light); color: white; }
        .btn-primary:hover { background-color: #004494; }
        .btn-primary:disabled { background-color: #cccccc; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-outline { background: transparent; border: 1px solid #ced4da; color: var(--text-main); }
        .btn-outline:hover { background: #f8f9fa; border-color: #adb5bd; }

        .btn-back { margin-bottom: 20px; background: none; border: none; color: var(--text-muted); font-size: 0.9rem; padding: 0; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-back:hover { color: var(--caa-blue-light); text-decoration: underline; }

        .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .selection-option { background: #fff; border: 2px solid #e9ecef; border-radius: var(--radius-main); padding: 20px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .selection-option:hover { border-color: #beccd6; transform: translateY(-2px); }
        .selection-option.selected { border-color: var(--caa-blue-light); background-color: #f0f7ff; box-shadow: 0 0 0 1px var(--caa-blue-light) inset; }
        .sel-icon { width: 40px; height: 40px; margin-bottom: 15px; color: var(--caa-blue); }
        .sel-icon svg { width: 100%; height: 100%; fill: currentColor; }
        .sel-label { font-weight: 700; color: var(--caa-blue); margin-bottom: 5px; display: block; }

        details { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        summary { padding: 12px 15px; font-weight: 600; cursor: pointer; color: var(--caa-blue); outline: none; }
        summary:hover { background-color: #eef2f5; }
        .info-content { padding: 15px; border-top: 1px solid #e9ecef; font-size: 0.95rem; line-height: 1.6; background: #fff; }
        .info-content ul { padding-left: 20px; margin: 0; }
        .info-content li { margin-bottom: 5px; }

        .airport-lookup-wrapper { background: #eef2f5; padding: 25px; border-radius: var(--radius-main); text-align: center; margin-bottom: 25px; }
        .lookup-input-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .lookup-input { padding: 10px 15px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem; width: 200px; }
        .lookup-result { margin-top: 15px; padding: 15px; border-radius: 4px; text-align: left; display: none; border: 1px solid transparent; }
        .res-ok { background: var(--status-success); color: var(--status-success-text); border-color: #c3e6cb; }
        .res-bad { background: var(--status-danger); color: var(--status-danger-text); border-color: #f5c6cb; }
        .res-warn { background: var(--status-warning); color: var(--status-warning-text); border-color: #ffeeba; }

        .action-bar { display: flex; gap: 15px; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .action-bar-center { justify-content: center; }
        
        .result-box { text-align: center; padding: 20px 0; }
        .result-icon { width: 64px; height: 64px; margin: 0 auto 20px auto; display: block; }
        .result-title { font-size: 1.8rem; margin-bottom: 15px; color: var(--caa-blue); }
        .result-desc { font-size: 1.1rem; line-height: 1.6; max-width: 600px; margin: 0 auto 30px auto; }
        
        .disclaimer { background-color: #e2e6ea; color: #383d41; padding: 15px; border-radius: 4px; font-size: 0.9rem; margin-top: 20px; border-left: 4px solid var(--caa-blue); }

        .inner-details { font-size: 0.85rem; margin-top: 10px; color: #555; text-align: left; width: 100%; }
        .inner-details summary { font-size: 0.8rem; padding: 5px 0; color: var(--caa-blue-light); }
        .inner-details .info-content { padding: 10px; border: 1px solid #eee; background: #fafafa; }

        @media (max-width: 600px) {
            .app-card { padding: 20px; }
            .action-bar { flex-direction: column; }
            .btn { width: 100%; }
            .lookup-input-group { flex-direction: column; }
            .lookup-input { width: 100%; }
            header h1 { font-size: 0.9rem; }
            .logo { height: 30px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <img src="https://luftfartstilsynet.no/globalassets/design/logo/lt-logo-hvit.svg" alt="Luftfartstilsynet Logo" class="logo">
            <h1>Veileder (EU) 2025/20<br>Ground Handling</h1>
        </div>
    </header>

    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('flowchart')">Flytskjema</button>
            <button class="tab-btn" onclick="switchTab('interactive')">Interaktiv veileder</button>
        </div>
    </div>

    <div class="main-container">
        
        <div id="view-flowchart" class="tab-content active">
            <div class="flowchart-wrapper">
                <h2 class="question-title">Oversikt over prosessen</h2>
                <p class="subtext">Klikk på bildet for å se større versjon, eller bruk den interaktive veilederen i neste fane.</p>
                <img src="Bakketjenester - flytskjema - engelske begreper.png" alt="Flytskjema for Ground Handling" class="flowchart-img">
            </div>
        </div>

        <div id="view-interactive" class="tab-content">
            <div id="app-card" class="app-card">
                </div>
        </div>

    </div>

<script>
    // --- TAB SWITCHING LOGIC ---
    function switchTab(tabId) {
        // Hide all content
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        // Deactivate all buttons
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

        // Show selected content
        document.getElementById('view-' + tabId).classList.add('active');
        // Activate button - find button that calls this function with specific ID
        const buttons = document.querySelectorAll('.tab-btn');
        if(tabId === 'flowchart') buttons[0].classList.add('active');
        if(tabId === 'interactive') buttons[1].classList.add('active');
    }


    // --- VEILEDER LOGIKK (DATABASE OG FUNKSJONER) --- 

    const airportDB = {
        "ENGM": { name: "Oslo lufthavn, Gardermoen", easa: true },
        "ENBR": { name: "Bergen lufthavn, Flesland", easa: true },
        "ENVA": { name: "Trondheim lufthavn, Værnes", easa: true },
        "ENZV": { name: "Stavanger lufthavn, Sola", easa: true },
        "ENTC": { name: "Tromsø lufthavn, Langnes", easa: true },
        "ENBL": { name: "Førde Lufthamn, Bringeland", easa: true },
        "ENBO": { name: "Bodø lufthavn", easa: true },
        "ENEV": { name: "Harstad/Narvik lufthavn, Evenes", easa: true },
        "ENCN": { name: "Kristiansand lufthavn, Kjevik", easa: true },
        "ENAL": { name: "Ålesund lufthavn, Vigra", easa: true },
        "ENHD": { name: "Haugesund lufthavn, Karmøy", easa: true },
        "ENML": { name: "Molde lufthavn, Årø", easa: true },
        "ENKR": { name: "Kirkenes lufthavn, Høybuktmoen", easa: true },
        "ENAT": { name: "Alta lufthavn", easa: true },
        "ENBS": { name: "Båtsfjord lufthavn", easa: true },
        "ENKB": { name: "Kristiansund lufthavn, Kvernberget", easa: true },
        "ENSB": { name: "Svalbard lufthavn, Longyear", easa: true },
        "ENSR": { name: "Sørkjosen lufthavn", easa: true },
        "ENTO": { name: "Sandefjord lufthavn, Torp", easa: true },
        "ENSO": { name: "Stord lufthavn", easa: true },
        "ENSG": { name: "Sogndal lufthamn, Haukåsen", easa: true },
        "ENSS": { name: "Vardø lufthavn, Svartnes", easa: true },
        "ENLK": { name: "Leknes lufthavn", easa: true },
        "ENMS": { name: "Mosjøen lufthavn, Kjærstad", easa: true },
        "ENST": { name: "Sandnessjøen lufthavn, Stokka", easa: true },
        "ENRY": { name: "Moss lufthavn, Rygge", easa: false },
        "ENOL": { name: "Ørland lufthavn", easa: false },
        "ENGK": { name: "Arendal lufthavn, Gullknapp", easa: false },
        "ENAN": { name: "Andøya lufthavn", easa: true },
        "ENHF": { name: "Hammerfest lufthavn", easa: true },
        "ENHV": { name: "Honningsvåg lufthavn, Valan", easa: true },
        "ENVD": { name: "Vadsø lufthavn", easa: true },
        "ENRS": { name: "Røst lufthavn", easa: true },
        "ENSH": { name: "Svolvær lufthavn", easa: true },
        "ENRA": { name: "Mo i Rana lufthavn", easa: true },
        "ENBN": { name: "Brønnøysund lufthavn", easa: true },
        "ENNA": { name: "Lakselv lufthavn, Banak", easa: true },
        "ENSD": { name: "Sandane lufthavn", easa: true },
        "ENFL": { name: "Florø lufthavn", easa: true },
        "ENOV": { name: "Hovden lufthavn, Ørsta/Volda", easa: true },
        "ENRM": { name: "Rørvik lufthavn", easa: true },
        "ENRO": { name: "Røros lufthavn", easa: true },
        "ENNM": { name: "Namsos lufthavn", easa: true },
        "ENMH": { name: "Mehamn lufthavn", easa: true },
        "ENBV": { name: "Berlevåg lufthavn", easa: true },
        "ENHK": { name: "Hasvik lufthavn", easa: true },
        "ENSK": { name: "Stokmarknes lufthavn", easa: true },
        "ENVR": { name: "Værøy Helikopterhavn, Tabbisodden", easa: true, isHelicopter: true },
        "ENBH": { name: "Bergen Helikopterhavn, Haakonsvern", easa: true, isHelicopter: true },
        "ENNO": { name: "Notodden lufthavn, Tuven", easa: false },
        "ENDU": { name: "Bardufoss lufthavn", easa: false }
    };

    let userSelectedNonEasa = false;
    let isHelicopterCase = false;

    const steps = [
        {
            id: 0,
            type: 'yesno',
            question: "Er virksomheten etablert på en EASA-lufthavn?",
            details: [
                {
                    title: "Hva er en EASA-lufthavn?",
                    content: `
                        <p><strong>Hva skiller en EASA-lufthavn fra en nasjonal lufthavn?</strong><br>
                        Forordning (EU) 2025/20 og 2025/23 gjelder kun bakketjenester levert på EASA-lufthavner. For å vite om lufthavnen dere opererer på er omfattet, må dere se på hvilke kriterier lufthavnen oppfyller etter basisforordning (EU) 2018/1139.</p>

                        <strong>1. Hva er en EASA-lufthavn? (Omfattet av regelverket)</strong>
                        <p>En lufthavn faller inn under EASA-regelverket (basisforordning 2018/1139 art. 2) dersom den oppfyller alle følgende kriterier:</p>
                        <ul>
                            <li>Den er åpen for allmenn bruk.</li>
                            <li>Den betjener næringsmessig lufttransport (kommersielle flyvninger).</li>
                            <li>Den har en asfaltert instrumentrullebane på 800 meter eller mer, eller betjener utelukkende helikoptre med instrumentinnflyging.</li>
                        </ul>
                        <p>Disse lufthavnene skal ha et EASA-sertifikat i henhold til forordning (EU) 139/2014.</p>

                        <a href="https://www.easa.europa.eu/en/datasets/aerodromes-falling-scope-regulation-eu-20181139" target="_blank" style="color:var(--caa-blue-light); text-decoration:underline;">Se fullstendig liste her (EASA)</a>`
                }
            ],
            lookupWidget: true, 
            yes: 1,
            no: "result_none"
        },
        {
            id: 1,
            type: 'selection',
            question: "Type virksomhet",
            subtext: "Velg kategorien som passer for din organisasjon.",
            choices: [
                { 
                    id: 'ghsp', label: 'Selvstendig GHSP', innerTitle: 'Ground Handling Service Provider',
                    innerDesc: "Tilbydere av bakketjenester på EASA-lufthavner, iht. basisforordning (EU) 2018/1139" 
                },
                { 
                    id: 'adr', label: 'ADR - Lufthavnoperatør', innerTitle: 'Lufthavnsoperatør',
                    innerDesc: "Lufthavnsoperatør som også er tilbyder av bakketjenester" 
                },
                { 
                    id: 'aoc', label: 'AOC med self-handling', innerTitle: 'Air Operator Certificate',
                    innerDesc: "CAT-operasjoner med komplekse, motordrevne fly med faste vinger" 
                }
            ],
            next: 2, 
            none: "result_none"
        },
        {
            id: 2,
            type: 'selection', 
            question: "Type bakketjenester",
            subtext: "Velg en av tjenestene dere tilbyr for å gå videre.",
            choices: [
                { 
                    id: 'pax', label: 'Passenger Handling', icon: '<svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>',
                    innerTitle: 'Tilbyder av bakketjenester innen håndtering av passasjerer:', 
                    innerDesc: `<ul><li>PRM (Personer med redusert mobilitet)</li><li>Oppsyn med passasjerer under boarding og de-boarding.</li><li>Transport av passasjerer mellom terminal og flymaskin.</li></ul><em>Ref. (EU) 2025/20 - Artikkel 2 - (a)</em>`
                },
                { 
                    id: 'bag', label: 'Baggage Handling', icon: '<svg viewBox="0 0 24 24"><path d="M20 6h-3V4c0-1.11-.89-2-2-2H9c-1.11 0-2 .89-2 2v2H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zM9 4h6v2H9V4zm11 15H4V8h16v11z"/></svg>',
                    innerTitle: 'Tilbyder av bakketjenester innen håndtering av bagasje:', 
                    innerDesc: `<ul><li>Sortering og stabling av bagasje</li><li>Transfer av bagasje</li><li>Transport og levering på transportbånd</li></ul><em>Ref. (EU) 2025/20 - Artikkel 2 - (b)</em>`
                },
                { 
                    id: 'air', label: 'Aircraft Servicing', icon: '<svg viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>',
                    innerTitle: 'Tilbyder av bakketjenester innen flyservice:', 
                    innerDesc: `<ul><li>Operasjoner med bakkeutstyr på flyoppstillingsplass</li><li>Lasting og lossing av catering</li><li>Flytanking</li><li>Toalettservice</li><li>Vannservice</li><li>Utvendig rengjøring av flymaskin</li><li>De-icing og anti-icing</li></ul><em>Ref. (EU) 2025/20 - Artikkel 2 - (c)</em>`
                },
                { 
                    id: 'turn', label: 'Turnaround Activities', icon: '<svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>',
                    innerTitle: 'Tilbyder av bakketjenester innen turn-around:', 
                    innerDesc: `<ul><li>Ankomsttjenster (FOD og sikring av flyvemaskin på flyoppstillingsplass)</li><li>Lasting og lossing av flymaskin, inkl. bagasje, frakt, catering og loading supervision</li><li>Avgangsprosedyrer</li><li>Push-back og tauing</li></ul><em>Ref. (EU) 2025/20 - Artikkel 2 - (d)</em>`
                },
                { 
                    id: 'cargo', label: 'Cargo & Mail Handling', icon: '<svg viewBox="0 0 24 24"><path d="M20 2H4c-1 0-2 .9-2 2v3.01c0 .72.43 1.34 1 1.69V20c0 1.1 1.1 2 2 2h14c.9 0 2-.9 2-2V8.7c.57-.35 1-.97 1-1.69V4c0-1.1-1-2-2-2zm-1 18H5V9h14v11zm1-13H4V4h16v3z"/></svg>',
                    innerTitle: 'Tilbyder av bakketjenester innen frakt og post:', 
                    innerDesc: `<ul><li>Aksept av frakt; på vegne av flyoperatøren</li><li>Siste oppbygging/ stabling og lagring av frakt</li><li>Siste veiing og tagging av ULD/ container</li><li>"Final checks" før luftftransport</li><li>Bakketransport av frakt og post mellom område for "Final checks" og flymaskin</li></ul>`
                }
            ],
            next: 3,
            none: "result_none"
        },
        {
            id: 3,
            type: 'yesno',
            question: "Er driften begrenset til ett eller flere av påfølgende punkter?",
            details: [
                { 
                    title: "Liste over unntatte tjenester", alwaysOpen: true, 
                    content: `
                    <ul>
                        <li>Marshalling, iht. <a href="https://www.easa.europa.eu/en/document-library/easy-access-rules/easy-access-rules-aerodromes-regulation-eu-no-1392014" target="_blank" style="color:var(--caa-blue-light); text-decoration:underline;">(EU) 139/2014</a></li>
                        <li>Flight dispatch, iht. <a href="https://www.easa.europa.eu/en/document-library/easy-access-rules/easy-access-rules-air-operations-regulation-eu-no-9652012" target="_blank" style="color:var(--caa-blue-light); text-decoration:underline;">(EU) 965/2012</a></li>
                        <li>Load control (herunder lasteplan, vekt og balanse, meldinger/kommunikasjon, utstedelse av dokumenter)</li>
                        <li>Ground supervision</li>
                        <li>Vedlikeholdsarbeid iht. <a href="https://www.easa.europa.eu/en/document-library/regulations/commission-regulation-eu-no-13212014" target="_blank" style="color:var(--caa-blue-light); text-decoration:underline;">(EU) 1321/2014</a>
                            <ul style="margin-top:5px; margin-bottom:5px; list-style-type: circle;">
                                <li>Oljeservice</li>
                                <li>Ekstern vask av flymaskin</li>
                                <li>Annet vedlikeholdsarbeid, inkl. tauing av fly.</li>
                            </ul>
                        </li>
                        <li>AOC self-handling
                            <ul style="margin-top:5px; margin-bottom:5px; list-style-type: circle;">
                                <li>CAT-operasjoner med ikke-komplekse motordrevne fly</li>
                                <li>Flyoperasjoner med komplekse eller annet-enn-komplekse motordrevne fly som ikke er CAT</li>
                            </ul>
                        </li>
                        <li>Lufthavnsoperatører som utelukkende
                            <ul style="margin-top:5px; margin-bottom:5px; list-style-type: circle;">
                                <li>Utfører PRM-tjeneste (personer med redusert mobilitet)</li>
                                <li>Utfører bakketransport av passasjerer og flybesetning (typisk busstjeneste)</li>
                            </ul>
                        </li>
                    </ul><div style="margin-top:20px; font-style:italic; color:#666; font-size:0.85rem;">Ref. (EU) 2025/20 - Artikkel 2 - (3)</div>` 
                }
            ],
            yes: "result_none",
            no: "result_declare"
        }
    ];

    const results = {
        "result_none": { 
            title: "Ingen deklarering", 
            desc: "Virksomheten er ikke omfattet av regelverket, og du trenger ikke å levere samsvarserklæring i henhold til (EU) 2025/20.<br><br><strong>Årsak:</strong> Tjenestene eller lufthavnen faller utenfor forordningens virkeområde.", 
            type: "res-none" 
        },
        "result_declare": { 
            title: "Krav om samsvarserklæring", 
            desc: "Virksomheten din er omfattet av regelverket og du må levere samsvarserklæring.<br><br><strong>Årsak:</strong> Dere utfører regulerte bakketjenester på en EASA-lufthavn.<br><br>Portalen for mottak av erklæringer åpnes tidligst 27. mars 2027.", 
            type: "res-action" 
        },
        "result_helicopter": {
            title: "Ingen deklarering (Helikopter-operasjoner)",
            desc: "Virksomheten er ikke omfattet av regelverket fordi helikopteroperasjoner er unntatt i henhold til forordning (EU) 2025/20.<br><br>Du trenger ikke å levere samsvarserklæring.",
            type: "res-heli"
        }
    };

    const container = document.getElementById('app-card');
    let historyStack = []; 

    function init() { renderStartPage(); }

    function restartApp() {
        historyStack = [];
        userSelectedNonEasa = false;
        isHelicopterCase = false;
        renderStartPage();
    }

    // Render Start Page
    function renderStartPage() {
        container.innerHTML = `
            <div style="text-align:center;">
                <h2 class="question-title">Er virksomheten min omfattet av regelverket?</h2>
                <div class="subtext">
                    <p>Denne veilederen hjelper deg å avklare om din organisasjon må levere samsvarserklæring for ground handling i henhold til forordning (EU) 2025/20.</p>
                </div>
                
                <div class="disclaimer">
                    <strong>Viktig informasjon:</strong>
                    Dette verktøyet er kun ment som veiledning. Det er organisasjonens eget ansvar å sette seg inn i og følge gjeldende regelverk.
                    <br><br>
                    Ved behov for avklaring, ta kontakt med Luftfartstilsynet på: <a href="mailto:postmottak@caa.no" style="color:var(--caa-blue-light);">postmottak@caa.no</a>
                </div>

                <div class="action-bar action-bar-center">
                    <button class="btn btn-primary" onclick="startFlow()">Start sjekken</button>
                </div>
            </div>
        `;
    }

    function startFlow() { renderStep(0); }

    function goBack() {
        if(historyStack.length > 0) {
            const prevStepId = historyStack.pop();
            renderStep(prevStepId, false); 
        } else {
            renderStartPage();
        }
    }

    function renderStep(stepId, pushToHistory = true) {
        const data = steps[stepId];
        
        let html = `
            ${stepId > 0 ? `<button class="btn-back" onclick="goBack()">← Tilbake</button>` : ''}
            <h2 class="question-title">${data.question}</h2>
            ${data.subtext ? `<div class="subtext">${data.subtext}</div>` : ''}
        `;

        if (data.lookupWidget) {
            html += `
            <div class="airport-lookup-wrapper">
                <label style="font-weight:600; display:block;">Søk på navn eller ICAO-kode:</label>
                <div class="lookup-input-group">
                    <input type="text" id="icao-input" class="lookup-input" placeholder="Eks. ENGM" onkeypress="if(event.key === 'Enter') checkAirport()">
                    <button class="btn btn-primary" onclick="checkAirport()">Sjekk</button>
                </div>
                <div id="lookup-result" class="lookup-result"></div>
            </div>
            `;
        }

        if (data.details) {
            data.details.forEach(d => {
                html += `<details ${d.alwaysOpen ? 'open' : ''}><summary>${d.title}</summary><div class="info-content">${d.content}</div></details>`;
            });
        }

        html += `<div class="action-bar ${data.type !== 'selection' ? 'action-bar-center' : ''}" id="action-area" style="${data.type === 'selection' ? 'flex-direction:column; border:none; padding:0;' : ''}">`;

        if (data.type === 'selection') {
            const choices = data.choices.map(c => `
                <div class="selection-option" id="choice-${c.id}" onclick="selectOption('${c.id}')">
                    ${c.icon ? `<div class="sel-icon">${c.icon}</div>` : ''}
                    <span class="sel-label">${c.label}</span>
                    <div class="inner-details">
                         <details onclick="event.stopPropagation()">
                            <summary>Les mer</summary>
                            <div class="info-content">
                                <strong>${c.innerTitle}</strong><br>
                                ${c.innerDesc}
                            </div>
                        </details>
                    </div>
                </div>`).join('');
            
            html += `
                <div class="selection-grid">${choices}</div>
                <div style="display:flex; justify-content:center; gap:15px; margin-top:20px;">
                     <button class="btn btn-primary" id="btn-cont" disabled onclick="handleResponse(${stepId}, 'continue')">Fortsett</button>
                     <button class="btn btn-outline" onclick="handleResponse(${stepId}, 'none')">Ingen av disse</button>
                </div>
            `;
        } else {
            const style = data.lookupWidget ? 'display:none;' : '';
            html += `
                <button class="btn btn-primary" id="btn-yes" style="${style}" onclick="handleResponse(${stepId}, true)">Ja</button>
                <button class="btn btn-secondary" id="btn-no" style="${style}" onclick="handleResponse(${stepId}, false)">Nei</button>
            `;
        }

        html += `</div>`; 

        container.innerHTML = html;
        window.scrollTo(0,0);
    }

    function checkAirport() {
        let input = document.getElementById(`icao-input`).value.trim().toUpperCase();
        const resBox = document.getElementById(`lookup-result`);
        const btnYes = document.getElementById('btn-yes');
        
        resBox.style.display = "block";
        
        let found = airportDB[input];

        if (!found) {
            const searchStr = input.toLowerCase();
            if (searchStr.length > 2) { 
                for (const [code, data] of Object.entries(airportDB)) {
                    if (data.name.toLowerCase().includes(searchStr)) {
                        found = data;
                        input = code; 
                        break; 
                    }
                }
            }
        }

        if (found) {
            if (found.isHelicopter) {
                userSelectedNonEasa = true;
                isHelicopterCase = true;
                resBox.className = "lookup-result res-warn";
                resBox.innerHTML = `<strong>${found.name} (${input})</strong><br>Helikopteroperasjoner er unntatt.<br><br>Virksomheten er dermed unntatt krav om å levere samsvarserklæring.`;
                btnYes.style.display = 'inline-block';
                btnYes.innerText = "Fortsett veilederen likevel";
                
            } else if (!found.easa) {
                userSelectedNonEasa = true;
                isHelicopterCase = false;
                resBox.className = "lookup-result res-bad";
                resBox.innerHTML = `<strong>${found.name} (${input})</strong> er IKKE en EASA-lufthavn.<br><br>Virksomheten er dermed unntatt krav om å levere samsvarserklæring.`;
                btnYes.style.display = 'inline-block';
                btnYes.innerText = "Fortsett veilederen likevel";

            } else {
                userSelectedNonEasa = false;
                isHelicopterCase = false;
                resBox.className = "lookup-result res-ok";
                resBox.innerHTML = `<strong>${found.name} (${input})</strong> er en EASA-lufthavn.`;
                btnYes.style.display = 'inline-block';
                btnYes.innerText = "Ja, gå videre";
            }
        } else {
            resBox.className = "lookup-result res-warn";
            resBox.innerHTML = "Fant ingen treff i listen over norske EASA-lufthavner.";
            btnYes.style.display = 'none';
        }
    }

    function selectOption(id) {
        document.querySelectorAll('.selection-option').forEach(el => el.classList.remove('selected'));
        document.getElementById('choice-'+id).classList.add('selected');
        document.getElementById('btn-cont').disabled = false;
    }

    function handleResponse(currentStepId, answer) {
        historyStack.push(currentStepId);

        let next = steps[currentStepId].type === 'selection' ? (answer === 'none' ? steps[currentStepId].none : steps[currentStepId].next) : (answer ? steps[currentStepId].yes : steps[currentStepId].no);
        
        if (typeof next !== 'number' && userSelectedNonEasa) {
             next = isHelicopterCase ? "result_helicopter" : "result_none";
        }

        if (typeof next === 'number') {
            renderStep(next, false); 
        } else {
            renderResult(next);
        }
    }

    function renderResult(key) {
        const res = results[key];
        let iconColor = "";
        let svgIcon = "";

        if (key === "result_declare") {
            iconColor = "var(--status-success-text)";
            svgIcon = `<svg viewBox="0 0 24 24"><path fill="${iconColor}" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`;
        } else if (key === "result_helicopter") {
            iconColor = "var(--status-warning-text)";
            svgIcon = `<svg viewBox="0 0 24 24"><path fill="${iconColor}" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`;
        } else {
            iconColor = "var(--status-danger-text)";
            svgIcon = `<svg viewBox="0 0 24 24"><path fill="${iconColor}" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`;
        }

        container.innerHTML = `
            <div class="result-box">
                <div class="result-icon">${svgIcon}</div>
                <h2 class="result-title">${res.title}</h2>
                <div class="result-desc">${res.desc}</div>
                <div class="action-bar action-bar-center">
                    <button class="btn btn-secondary" onclick="restartApp()">Start på nytt</button>
                </div>
            </div>
        `;
        window.scrollTo(0,0);
    }

    // Start
    init();

</script>
</body>
</html>